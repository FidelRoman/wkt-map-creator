<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WKT Map Creator</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

    <!-- Turf.js (v6.5.0 for stability) -->
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div id="login-overlay">
        <div class="login-card">
            <h2>Bienvenido</h2>
            <p>Inicia sesión para guardar y compartir tus mapas</p>
            <button id="google-login-btn" class="btn-google">
                <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.247h2.899c1.697-1.565 2.695-3.868 2.695-6.604z"
                        fill="#4285F4"></path>
                    <path
                        d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.899-2.247c-.808.54-1.843.858-3.057.858-2.344 0-4.328-1.584-5.035-3.691H.95v2.333A8.997 8.997 0 0 0 9 18z"
                        fill="#34A853"></path>
                    <path
                        d="M3.964 10.74a5.41 5.41 0 0 1-.282-1.74c0-.603.102-1.18.282-1.74V4.927H.95a9.006 9.006 0 0 0 0 7.427l3.014-2.333z"
                        fill="#FBBC05"></path>
                    <path
                        d="M9 3.58c1.321 0 2.508.455 3.44 1.345l2.583-2.583C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .95 4.927l3.015 2.333C4.67 5.163 6.655 3.58 9 3.58z"
                        fill="#EA4335"></path>
                </svg>
                Continuar con Google
            </button>
        </div>
    </div>

    <div id="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Projects Section -->
            <div class="sidebar-header" style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                    <h2>Proyectos</h2>
                    <div style="display:flex; gap:6px;">
                        <button id="share-project-btn" class="btn-sm" title="Compartir" style="display:none;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <circle cx="18" cy="5" r="3"></circle>
                                <circle cx="6" cy="12" r="3"></circle>
                                <circle cx="18" cy="19" r="3"></circle>
                                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                            </svg>
                        </button>
                        <button id="new-project-btn" class="btn-sm" title="Nuevo Proyecto">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </button>
                    </div>
                </div>
                <!-- Project Select List -->
                <div id="project-list-container"
                    style="max-height: 150px; overflow-y: auto; margin-top: 10px; display:none;">
                    <!-- Injected via JS -->
                </div>
                <div id="current-project-display"
                    style="margin-top: 10px; font-weight: 500; font-size: 0.9rem; color:#475569; display:flex; align-items:center; justify-content:space-between; cursor:pointer; padding:6px; border-radius:6px; background:white; border:1px solid #e2e8f0;">
                    <span id="current-project-name">Sin Proyecto</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
            </div>

            <!-- Layers Section -->
            <div class="layers-header">
                <h2>Capas</h2>
                <div class="layers-actions">
                    <button id="add-layer-btn" class="btn-sm" title="Nueva Capa">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                    <button id="import-csv-btn" class="btn-sm" title="Importar CSV">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="sidebar-content"
                style="flex: 0 0 150px; min-height: 100px; border-bottom: 1px solid #e2e8f0; padding: 0;">
                <ul id="layers-list">
                    <!-- Layers injected here -->
                </ul>
            </div>

            <!-- Polygons Section (Active Layer Content) -->
            <div class="sidebar-header">
                <h2>Objetos</h2>
                <button id="import-wkt-btn" class="btn-sm" title="Importar WKT a capa activa">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                </button>
            </div>
            <div class="sidebar-content">
                <ul id="polygon-list">
                    <!-- List items will be injected here -->
                </ul>
            </div>

            <!-- Hidden File Input for CSV -->
            <input type="file" id="csv-file-input" accept=".csv" style="display: none;" />

            <!-- User Profile (Injected via JS) -->
            <div id="user-profile" class="user-profile" style="display: none;">
                <!-- Content injected by auth.js -->
            </div>
        </div>

        <div id="map"></div>

        <div class="ui-overlay">
            <header class="app-header">
                <h1>WKT Map Creator</h1>
                <p>Dibuja, edita y opera con polígonos</p>
            </header>

            <div class="controls-panel">
                <div class="stats">
                    <span id="polygon-count">0</span> polígonos
                </div>
                <button id="clear-btn" class="btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Limpiar Todo
                </button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu" class="context-menu">
        <div class="menu-item" id="copy-wkt">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span>Copiar WKT</span>
            <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        </div>
        <div class="menu-item" id="subtract-poly" style="display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12h14" />
            </svg>
            <span>Restar selección</span>
        </div>
        <div class="menu-item" id="edit-layer">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
            </svg>
            <span>Editar</span>
        </div>
        <div class="menu-item" id="delete-layer" style="color: #ef4444;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            <span>Eliminar</span>
        </div>
    </div>

    <!-- WKT Import Modal -->
    <div id="wkt-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Importar WKT</h3>
            <textarea id="wkt-input" placeholder="Pega tu POLYGON((...)) aquí..."></textarea>
            <div class="modal-actions">
                <button id="cancel-wkt" class="btn-secondary">Cancelar</button>
                <button id="confirm-wkt" class="btn-primary">Importar</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Leaflet Draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <!-- Firebase SDKs (Compat version for simple HTML usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <!-- Custom JS -->
    <script src="firestore.js"></script>
    <script src="auth.js"></script>
    <script src="script.js"></script>
</body>

</html>